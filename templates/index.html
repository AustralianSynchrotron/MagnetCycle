<!DOCTYPE html>
<html>
  <head>
    <title>Magnet Cycle</title>
    <link rel=stylesheet type=text/css href='{{ url_for("static", filename="css/style.css") }}'>
    <script src='{{ url_for("static", filename="js/knockout.js") }}'></script>
    <script>
      ko.extenders.numeric = function(target, precision) {
          var result = ko.dependentObservable({
            read: function() {
              return target().toFixed(precision); 
            },
            write: target 
          });
          result.raw = target;
          return result;
      };

      function AppViewModel() {
        {% for mag in magnets %}
          this['{{mag.base_code}}_CURRENT_SP'] = ko.observable({{mag.setpoint}}).extend({numeric: 3});
          this['{{mag.base_code}}_CURRENT_MONITOR'] = ko.observable({{mag.readback}}).extend({numeric: 3});
          this['{{mag.base_code}}_CYCLE_STATUS'] = ko.observable('{{mag.cycle_status}}');
        {% endfor %}
      }
      var viewModel = new AppViewModel();

      var loc = window.location;
      var socket = new WebSocket('ws://'+loc.hostname+':'+loc.port+'/socket');
      socket.onmessage = function(event) {
        var data = JSON.parse(event.data);
        var property = data.pvname.replace(/[:-]/g, '_');
        viewModel[property](data.value);
      }

      document.addEventListener('DOMContentLoaded', function() {
        ko.applyBindings(viewModel);
      });
    </script>
  </head>
  <body>

    {% macro table(mags) %}
      <table>
        <colgroup>
          <col class='name'>
          <col class='value'>
          <col class='value'>
          <col class='status'>
          <col class='cycle'>
        </colgroup>
        <thead>
          <tr>
            <th>Name</th>
            <th>Setpoint</th>
            <th>Readback</th>
            <th>Status</th>
            <th>Cycle</th>
          </tr>
        </thead>
        <tbody>
          {% for mag in mags %}
            <tr>
              <td>{{ mag.label }}</td>
              <td data-bind='text: {{mag.base_code}}_CURRENT_SP'></td>
              <td data-bind='text: {{mag.base_code}}_CURRENT_MONITOR'></td>
              <td data-bind='text: {{mag.base_code}}_CYCLE_STATUS'></td>
              <td><input type='checkbox'/></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endmacro %}

    {{ table(magnets[:12]) }}
    {{ table(magnets[12:24]) }}
    {{ table(magnets[24:]) }}

 </body>
</html>
